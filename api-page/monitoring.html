<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Monitoring Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f6fa;
      color: #2f3640;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #273c75;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .status-box, .route-box, .chart-box {
      background-color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .route-list {
      list-style-type: none;
      padding-left: 0;
    }
    .route-list li {
      margin: 5px 0;
      padding: 8px;
      border-radius: 6px;
    }
    .active-route {
      background-color: #d4edda;
      color: #155724;
    }
    .inactive-route {
      background-color: #f8d7da;
      color: #721c24;
    }
    .error-log {
      background-color: #fff3cd;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API Monitoring Dashboard</h1>

    <div class="status-box">
      <h2>Server Status</h2>
      <p>Status: <strong id="server-status">Loading...</strong></p>
      <p>Time: <strong id="server-time">Loading...</strong></p>
      <p>Uptime: <strong id="server-uptime">Loading...</strong></p> <!-- Uptime ditambahkan di sini -->
      <p>Total API Routes: <strong id="total-api-routes">Loading...</strong></p> <!-- Total API Routes ditambahkan -->
    </div>

    <div class="route-box">
      <h2>API Routes</h2>
      <ul id="route-list" class="route-list">
        <li>Loading...</li>
      </ul>
    </div>

    <div class="chart-box">
      <h2>Active Routes (Real-time)</h2>
      <canvas id="statusChart" height="100"></canvas>
    </div>

    <div class="status-box">
      <h2>Recent Error Logs</h2>
      <ul id="error-logs" class="route-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>

  <script>
    const ctx = document.getElementById('statusChart').getContext('2d');
    const chartData = {
      labels: [],
      datasets: [{
        label: 'Active Routes',
        data: [],
        backgroundColor: 'rgba(0, 123, 255, 0.3)',
        borderColor: 'rgba(0, 123, 255, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    };

    const statusChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        scales: {
          x: {
            title: { display: true, text: 'Time' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Active Count' }
          }
        }
      }
    });

    function updateDashboard() {
      fetch('/monitoring')
        .then(res => res.json())
        .then(data => {
          document.getElementById('server-status').textContent = data.serverStatus;
          document.getElementById('server-time').textContent = data.time;
          document.getElementById('server-uptime').textContent = data.uptime; // Menambahkan tampilan uptime
          document.getElementById('total-api-routes').textContent = data.apiRoutes.length; // Menambahkan total API routes

          const routeList = document.getElementById('route-list');
          routeList.innerHTML = '';

          let activeCount = 0;

          data.apiRoutes.forEach(route => {
            const li = document.createElement('li');
            li.textContent = `${route.path} â€” ${route.status}`;
            li.classList.add(route.status === 'Active' ? 'active-route' : 'inactive-route');
            routeList.appendChild(li);
            if (route.status === 'Active') activeCount++;
          });

          // Chart update
          const now = new Date().toLocaleTimeString();
          if (chartData.labels.length >= 10) {
            chartData.labels.shift();
            chartData.datasets[0].data.shift();
          }
          chartData.labels.push(now);
          chartData.datasets[0].data.push(activeCount);
          statusChart.update();

          // Tampilkan error logs
          const errorLogsContainer = document.getElementById('error-logs');
          errorLogsContainer.innerHTML = '';

          if (data.errorLogs && data.errorLogs.length > 0) {
            data.errorLogs.slice(-5).reverse().forEach(log => {
              const li = document.createElement('li');
              li.classList.add('error-log');
              li.textContent = `${log.time}: ${log.message}`;
              errorLogsContainer.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'No recent errors.';
            errorLogsContainer.appendChild(li);
          }
        })
        .catch(err => {
          document.getElementById('server-status').textContent = 'Error';
          document.getElementById('server-time').textContent = 'N/A';
          document.getElementById('server-uptime').textContent = 'N/A'; // Error handling untuk uptime
          document.getElementById('route-list').innerHTML = '<li class="inactive-route">Gagal mengambil data</li>';
          document.getElementById('total-api-routes').textContent = 'N/A'; // Error handling untuk total API routes
          document.getElementById('error-logs').innerHTML = '<li class="error-log">Gagal mengambil error logs</li>';
        });
    }

    // Run first time
    updateDashboard();
    // Update every 5 seconds
    setInterval(updateDashboard, 5000);
  </script>
</body>
</html>
